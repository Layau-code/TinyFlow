name: Deploy TinyFlow

on:
  push:
    branches: [master, main]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      # 3. å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
      - name: Build Frontend
        run: |
          cd web
          npm ci
          npm run build
        env:
          VITE_SHORT_BASE: ${{ secrets.APP_DOMAIN }}
          VITE_API_BASE: ${{ secrets.API_BASE || '' }}

      # 4. è®¾ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # 5. è¿è¡Œåç«¯æµ‹è¯•
      - name: Run Backend Tests
        run: mvn clean test
        env:
          APP_DOMAIN: ${{ secrets.APP_DOMAIN }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      # 6. æ„å»ºåç«¯ï¼ˆè·³è¿‡æµ‹è¯•ï¼Œå› ä¸ºå·²ç»è¿è¡Œè¿‡ï¼‰
      - name: Build Backend Package
        run: mvn clean package -DskipTests
        env:
          APP_DOMAIN: ${{ secrets.APP_DOMAIN }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      # 7. ä¸Šä¼  JAR åŒ…åˆ°æœåŠ¡å™¨
      - name: Upload JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "target/TinyFlow-0.0.1-SNAPSHOT.jar"
          target: "/opt/TinyFlow/target/"
          strip_components: 1
          overwrite: true

      # 8. ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©åˆ°æœåŠ¡å™¨
      - name: Upload Frontend to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "web/dist/"
          target: "/opt/TinyFlow/"
          strip_components: 1
          rm: true  # åˆ é™¤æ—§æ–‡ä»¶å†ä¸Šä¼ ï¼Œç¡®ä¿æ¸…é™¤æ—§çš„hashæ–‡ä»¶

      # 9. é‡å¯æœåŠ¡
      - name: Restart Service
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_DOMAIN: ${{ secrets.APP_DOMAIN }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APP_DOMAIN,DB_PASSWORD,JWT_SECRET,REDIS_PASSWORD
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            sudo mkdir -p /opt/TinyFlow/target
            sudo mkdir -p /opt/TinyFlow/web/dist
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸ
            echo "ğŸ“¦ æ£€æŸ¥éƒ¨ç½²æ–‡ä»¶..."
            if [ ! -f "/opt/TinyFlow/target/TinyFlow-0.0.1-SNAPSHOT.jar" ]; then
              echo "âŒ JAR æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            echo "âœ… JAR æ–‡ä»¶å·²ä¸Šä¼ "
            
            if [ ! -d "/opt/TinyFlow/web/dist" ]; then
              echo "âŒ å‰ç«¯èµ„æºç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            echo "âœ… å‰ç«¯èµ„æºå·²ä¸Šä¼ "
            ls -la /opt/TinyFlow/web/dist/assets/ | head -5
            
            # é‡å¯æœåŠ¡
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            sudo systemctl daemon-reload
            sudo systemctl restart tinyflow
            
            # é‡è½½ Nginx ä»¥ç¡®ä¿é™æ€èµ„æºæ›´æ–°
            echo "ğŸ”„ é‡è½½ Nginx..."
            sudo nginx -s reload
            
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if ! systemctl is-active --quiet tinyflow; then
              echo "âŒ æœåŠ¡æœªè¿è¡Œï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
              journalctl -u tinyflow -n 50 --no-pager
              exit 1
            fi
            
            echo "âœ… systemdæœåŠ¡å·²å¯åŠ¨ï¼Œç­‰å¾…åº”ç”¨å®Œå…¨å°±ç»ª..."
            
            # å¥åº·æ£€æŸ¥
            MAX_RETRY=12
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health)
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… éƒ¨ç½²å®Œæˆï¼æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡ (HTTP $HTTP_CODE)"
                exit 0
              elif [ "$HTTP_CODE" != "000" ]; then
                echo "âš ï¸  æœåŠ¡å“åº”ä½†çŠ¶æ€ä¸æ˜¯OK (HTTP $HTTP_CODE)ï¼Œç»§ç»­ç­‰å¾…..."
              fi
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "â³ ç¬¬ $RETRY_COUNT/$MAX_RETRY æ¬¡æ£€æŸ¥ï¼Œç­‰å¾… 10 ç§’åé‡è¯•..."
              sleep 10
            done
            
            echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶ï¼Œæœ€åçŠ¶æ€ç : $HTTP_CODE"
            journalctl -u tinyflow -n 100 --no-pager | grep -E "ERROR|WARN|Exception" || journalctl -u tinyflow -n 50 --no-pager
            exit 1

      # 10. éƒ¨ç½²å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment Failed
        if: failure()
        run: echo "âŒ TinyFlow éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"

      # 11. éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Deployment Success
        if: success()
        run: echo "âœ… TinyFlow éƒ¨ç½²æˆåŠŸï¼"