# ç†”æ–­é™çº§æœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [ObservabilityConfig.java](file://src/main/java/com/layor/tinyflow/config/ObservabilityConfig.java)
- [ClickRecorderService.java](file://src/main/java/com/layor/tinyflow/service/ClickRecorderService.java)
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java)
- [application.yml](file://src/main/resources/application.yml)
- [ShortUrlService.java](file://src/main/java/com/layor/tinyflow/service/ShortUrlService.java)
- [RabbitMQConfig.java](file://src/main/java/com/layor/tinyflow/config/RabbitMQConfig.java)
- [ClickMessageConsumer.java](file://src/main/java/com/layor/tinyflow/service/ClickMessageConsumer.java)
- [DeadLetterConsumer.java](file://src/main/java/com/layor/tinyflow/service/DeadLetterConsumer.java)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [Resilience4j é›†æˆä¸é…ç½®](#resilience4j-é›†æˆä¸é…ç½®)
3. [ç†”æ–­å™¨çŠ¶æ€æœºåŸç†](#ç†”æ–­å™¨çŠ¶æ€æœºåŸç†)
4. [ClickRecorderService ä¸­çš„ç†”æ–­ä¿æŠ¤](#clickrecorderservice-ä¸­çš„ç†”æ–­ä¿æŠ¤)
5. [CircuitBreakerEventListener äº‹ä»¶ç›‘å¬](#circuitbreaker-event-listener-äº‹ä»¶ç›‘å¬)
6. [ç†”æ–­ç­–ç•¥é…ç½®ä¸æœ€ä½³å®è·µ](#ç†”æ–­ç­–ç•¥é…ç½®ä¸æœ€ä½³å®è·µ)
7. [é«˜è´Ÿè½½ä¸‹çš„ä¿æŠ¤æ•ˆæœåˆ†æ](#é«˜è´Ÿè½½ä¸‹çš„ä¿æŠ¤æ•ˆæœåˆ†æ)
8. [æ€§èƒ½å¼€é”€è¯„ä¼°](#æ€§èƒ½å¼€é”€è¯„ä¼°)
9. [æ€»ç»“](#æ€»ç»“)

## å¼•è¨€
ç†”æ–­é™çº§æœºåˆ¶æ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿éšœæœåŠ¡ç¨³å®šæ€§çš„å…³é”®ç»„ä»¶ã€‚åœ¨ TinyFlow ç³»ç»Ÿä¸­ï¼Œé€šè¿‡é›†æˆ Resilience4j æ¡†æ¶å®ç°äº†å¯¹å…³é”®ä¾èµ–ï¼ˆå¦‚ Redisã€æ•°æ®åº“ï¼‰çš„ä¿æŠ¤ï¼Œé˜²æ­¢å› ä¸‹æ¸¸æœåŠ¡æ•…éšœå¯¼è‡´çš„é›ªå´©æ•ˆåº”ã€‚æœ¬æ–‡æ¡£å°†æ·±å…¥åˆ†æç³»ç»Ÿä¸­ç†”æ–­é™çº§æœºåˆ¶çš„å®ç°ï¼Œé‡ç‚¹ä»‹ç» Resilience4j çš„é…ç½®ã€ä½¿ç”¨æ–¹å¼ä»¥åŠåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ä¿æŠ¤æ•ˆæœã€‚

## Resilience4j é›†æˆä¸é…ç½®
TinyFlow ç³»ç»Ÿé€šè¿‡ `resilience4j-spring-boot3` ä¾èµ–é›†æˆäº† Resilience4j æ¡†æ¶ï¼Œå®ç°äº†ç†”æ–­å™¨ï¼ˆCircuitBreakerï¼‰ã€é™æµå™¨ï¼ˆRateLimiterï¼‰ã€é‡è¯•ï¼ˆRetryï¼‰å’Œèˆ±å£éš”ç¦»ï¼ˆBulkheadï¼‰ç­‰å¤šç§å®¹é”™æ¨¡å¼ã€‚

### æ ¸å¿ƒä¾èµ–
```xml
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot3</artifactId>
    <version>2.2.0</version>
</dependency>
```

### é…ç½®æ–‡ä»¶ä¸­çš„ç†”æ–­ç­–ç•¥
åœ¨ `application.yml` ä¸­å®šä¹‰äº†å¤šä¸ªç†”æ–­å™¨å®ä¾‹ï¼Œåˆ†åˆ«ç”¨äºä¿æŠ¤ä¸åŒçš„ç³»ç»Ÿç»„ä»¶ï¼š

```yaml
resilience4j:
  circuitbreaker:
    instances:
      # Redis ç†”æ–­å™¨ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
      redisBreaker:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 5
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 1000ms
        recordExceptions:
          - org.springframework.data.redis.RedisConnectionFailureException
          - java.net.SocketTimeoutException
        ignoreExceptions:
          - java.lang.IllegalArgumentException
        eventConsumerBufferSize: 100
      
      # æ•°æ®åº“ç†”æ–­å™¨ï¼ˆæ…¢è°ƒç”¨ä¿æŠ¤ï¼‰
      dbBreaker:
        registerHealthIndicator: true
        slidingWindowType: TIME_BASED
        slidingWindowSize: 60
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        slowCallRateThreshold: 70
        slowCallDurationThreshold: 2000ms
        recordExceptions:
          - org.springframework.dao.DataAccessException
          - java.sql.SQLException
        eventConsumerBufferSize: 100
```

**é…ç½®è¯´æ˜ï¼š**
- **redisBreaker**: åŸºäºè®¡æ•°çš„æ»‘åŠ¨çª—å£ï¼Œå½“100æ¬¡è°ƒç”¨ä¸­æœ‰è¶…è¿‡50%çš„å¤±è´¥ç‡æ—¶è§¦å‘ç†”æ–­ï¼Œè¿›å…¥å¼€å¯çŠ¶æ€30ç§’åè‡ªåŠ¨è¿›å…¥åŠå¼€çŠ¶æ€ã€‚
- **dbBreaker**: åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£ï¼ˆ60ç§’ï¼‰ï¼Œç”¨äºä¿æŠ¤æ•°æ®åº“æ…¢æŸ¥è¯¢ï¼Œå½“æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡70%æ—¶è§¦å‘ç†”æ–­ã€‚

**Section sources**
- [application.yml](file://src/main/resources/application.yml#L148-L189)

## ç†”æ–­å™¨çŠ¶æ€æœºåŸç†
Resilience4j çš„ç†”æ–­å™¨å®ç°äº†ç»å…¸çš„ä¸‰æ€çŠ¶æ€æœºæ¨¡å‹ï¼š**å…³é—­ï¼ˆCLOSEDï¼‰**ã€**å¼€å¯ï¼ˆOPENï¼‰** å’Œ **åŠå¼€ï¼ˆHALF_OPENï¼‰**ã€‚

```mermaid
stateDiagram-v2
[*] --> CLOSED
CLOSED --> OPEN : å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼
OPEN --> HALF_OPEN : ç­‰å¾…æ—¶é—´ç»“æŸ
HALF_OPEN --> CLOSED : è¯•æ¢è°ƒç”¨æˆåŠŸ
HALF_OPEN --> OPEN : è¯•æ¢è°ƒç”¨å¤±è´¥
```

**Diagram sources**
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java#L37-L57)

### çŠ¶æ€è½¬æ¢æ¡ä»¶
1. **CLOSED â†’ OPEN**: å½“æ»‘åŠ¨çª—å£å†…çš„å¤±è´¥ç‡è¶…è¿‡ `failureRateThreshold`ï¼ˆé»˜è®¤50%ï¼‰æ—¶ï¼Œç†”æ–­å™¨è·³é—¸ï¼Œè¿›å…¥å¼€å¯çŠ¶æ€ã€‚
2. **OPEN â†’ HALF_OPEN**: åœ¨ `waitDurationInOpenState`ï¼ˆRedisä¸º30ç§’ï¼ŒDBä¸º60ç§’ï¼‰åï¼Œç†”æ–­å™¨è‡ªåŠ¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå…è®¸æœ‰é™æ•°é‡çš„è¯•æ¢è°ƒç”¨ã€‚
3. **HALF_OPEN â†’ CLOSED**: å¦‚æœè¯•æ¢è°ƒç”¨å…¨éƒ¨æˆåŠŸï¼Œç†”æ–­å™¨æ¢å¤æ­£å¸¸ï¼Œå›åˆ°å…³é—­çŠ¶æ€ã€‚
4. **HALF_OPEN â†’ OPEN**: å¦‚æœä»»ä½•è¯•æ¢è°ƒç”¨å¤±è´¥ï¼Œç†”æ–­å™¨ç«‹å³é‡æ–°å¼€å¯ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªå†·å´å‘¨æœŸã€‚

è¿™ç§çŠ¶æ€æœºè®¾è®¡æœ‰æ•ˆé˜²æ­¢äº†åœ¨æœåŠ¡æœªå®Œå…¨æ¢å¤æ—¶å¤§é‡è¯·æ±‚æ¶Œå…¥å¯¼è‡´çš„äºŒæ¬¡é›ªå´©ã€‚

## ClickRecorderService ä¸­çš„ç†”æ–­ä¿æŠ¤
`ClickRecorderService` æœåŠ¡è´Ÿè´£è®°å½•çŸ­é“¾ç‚¹å‡»äº‹ä»¶ï¼Œé€šè¿‡å¼‚æ­¥å¤„ç†å’Œå¤šçº§ç¼“å†²æœºåˆ¶æ¥æé«˜æ€§èƒ½ã€‚è™½ç„¶è¯¥æœåŠ¡æœ¬èº«ä¸ç›´æ¥ä½¿ç”¨ç†”æ–­å™¨ï¼Œä½†å…¶è°ƒç”¨é“¾ä¸­çš„ `ShortUrlService` ä½¿ç”¨äº†ç†”æ–­ä¿æŠ¤ã€‚

### ç‚¹å‡»äº‹ä»¶è®°å½•æµç¨‹
```mermaid
flowchart TD
A[ç”¨æˆ·è®¿é—®çŸ­é“¾] --> B[ShortUrlService.redirectCode]
B --> C{RateLimiter æ£€æŸ¥}
C --> |é€šè¿‡| D[getLongUrlByShortCode]
D --> E{CircuitBreaker æ£€æŸ¥}
E --> |CLOSED| F[æŸ¥è¯¢ L1 ç¼“å­˜]
E --> |OPEN| G[æ‰§è¡Œé™çº§é€»è¾‘]
F --> H[æŸ¥è¯¢ L2 Redis]
H --> I[æŸ¥è¯¢ L3 æ•°æ®åº“]
I --> J[å›å¡«ç¼“å­˜]
J --> K[recordClick]
K --> L[recordClickEvent]
L --> M[è¿”å›é‡å®šå‘]
```

**Diagram sources**
- [ShortUrlService.java](file://src/main/java/com/layor/tinyflow/service/ShortUrlService.java#L289-L353)
- [ClickRecorderService.java](file://src/main/java/com/layor/tinyflow/service/ClickRecorderService.java#L68-L76)

### RabbitMQ è°ƒç”¨ä¿æŠ¤
è™½ç„¶ `ClickRecorderService` ä¸­çš„ `recordClick` æ–¹æ³•æ²¡æœ‰ç›´æ¥ä½¿ç”¨ç†”æ–­å™¨ï¼Œä½†ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶ä¿æŠ¤ RabbitMQ è°ƒç”¨ï¼š

1. **ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶**ï¼šåœ¨ `RabbitTemplate` ä¸­é…ç½®äº† `confirmCallback` å’Œ `returnsCallback`ï¼Œç¡®ä¿æ¶ˆæ¯å¯é æŠ•é€’ã€‚
2. **æ­»ä¿¡é˜Ÿåˆ—**ï¼šé…ç½®äº† TTL ä¸º30ç§’çš„æ¶ˆæ¯è¿‡æœŸç­–ç•¥ï¼Œå¤±è´¥æ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ç”± `DeadLetterConsumer` å¤„ç†ã€‚
3. **æ¶ˆè´¹è€…é‡è¯•**ï¼šæ¶ˆè´¹è€…æœ€å¤šé‡è¯•3æ¬¡ï¼Œé¿å…å› ä¸´æ—¶æ•…éšœå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚

```java
// RabbitMQConfig.java
@Bean
public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
    RabbitTemplate template = new RabbitTemplate(connectionFactory);
    
    // å‘é€ç¡®è®¤å›è°ƒ
    template.setConfirmCallback((correlationData, ack, cause) -> {
        if (!ack) {
            System.err.println("[MQ CONFIRM FAILED] Message not delivered to exchange: " + cause);
        }
    });
    
    // æ¶ˆæ¯è¿”å›å›è°ƒ
    template.setReturnsCallback(returned -> {
        System.err.println("[MQ RETURN] Message returned: " + returned.getReplyText());
    });
    
    return template;
}
```

**Section sources**
- [RabbitMQConfig.java](file://src/main/java/com/layor/tinyflow/config/RabbitMQConfig.java#L101-L123)
- [ClickMessageConsumer.java](file://src/main/java/com/layor/tinyflow/service/ClickMessageConsumer.java#L47-L86)
- [DeadLetterConsumer.java](file://src/main/java/com/layor/tinyflow/service/DeadLetterConsumer.java#L29-L57)

## CircuitBreakerEventListener äº‹ä»¶ç›‘å¬
`CircuitBreakerEventListener` ç±»è´Ÿè´£ç›‘å¬ç†”æ–­å™¨çš„çŠ¶æ€å˜åŒ–äº‹ä»¶ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å‘Šè­¦å’Œæ—¥å¿—è®°å½•ã€‚

```java
@Bean
public CircuitBreakerRegistry circuitBreakerRegistry() {
    CircuitBreakerRegistry registry = CircuitBreakerRegistry.ofDefaults();
    
    registry.getAllCircuitBreakers().forEach(circuitBreaker -> {
        circuitBreaker.getEventPublisher()
            .onStateTransition(this::onStateTransition)
            .onError(event -> log.error("CircuitBreaker [{}] recorded error: {}", 
                event.getCircuitBreakerName(), event.getThrowable().getMessage()))
            .onSuccess(event -> log.debug("CircuitBreaker [{}] recorded success", 
                event.getCircuitBreakerName()));
    });
    
    return registry;
}

private void onStateTransition(CircuitBreakerOnStateTransitionEvent event) {
    CircuitBreaker.State fromState = event.getStateTransition().getFromState();
    CircuitBreaker.State toState = event.getStateTransition().getToState();
    
    log.warn("âš¡ CircuitBreaker [{}] state changed: {} â†’ {}", 
        event.getCircuitBreakerName(), fromState, toState);
    
    // ç†”æ–­æ‰“å¼€æ—¶å‘é€å‘Šè­¦
    if (toState == CircuitBreaker.State.OPEN) {
        log.error("ğŸ”´ ALERT: CircuitBreaker [{}] is now OPEN! System degraded.", 
            event.getCircuitBreakerName());
        // TODO: å‘é€å‘Šè­¦åˆ°ç›‘æ§å¹³å°
    }
    
    // ç†”æ–­æ¢å¤æ—¶è®°å½•æ—¥å¿—
    if (toState == CircuitBreaker.State.CLOSED) {
        log.info("ğŸŸ¢ CircuitBreaker [{}] is now CLOSED. System recovered.", 
            event.getCircuitBreakerName());
    }
}
```

è¯¥ç›‘å¬å™¨å®ç°äº†ï¼š
- **çŠ¶æ€å˜æ›´æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰çŠ¶æ€è½¬æ¢ï¼Œä¾¿äºé—®é¢˜è¿½è¸ªã€‚
- **å¼€å¯å‘Šè­¦**ï¼šå½“ç†”æ–­å™¨æ‰“å¼€æ—¶ï¼Œè¾“å‡ºçº¢è‰²å‘Šè­¦æ—¥å¿—ï¼Œæç¤ºç³»ç»Ÿå·²é™çº§ã€‚
- **æ¢å¤é€šçŸ¥**ï¼šå½“ç†”æ–­å™¨å…³é—­æ—¶ï¼Œè®°å½•ç»¿è‰²æ¢å¤æ—¥å¿—ã€‚
- **é”™è¯¯ç›‘æ§**ï¼šè®°å½•æ¯æ¬¡è°ƒç”¨å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯ã€‚

**Section sources**
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java#L17-L57)

## ç†”æ–­ç­–ç•¥é…ç½®ä¸æœ€ä½³å®è·µ
### é…ç½®æœ€ä½³å®è·µ
1. **å·®å¼‚åŒ–é…ç½®**ï¼šæ ¹æ®ä¾èµ–æœåŠ¡çš„ç‰¹æ€§é…ç½®ä¸åŒçš„ç†”æ–­ç­–ç•¥ã€‚å¦‚ Redis ä½¿ç”¨åŸºäºè®¡æ•°çš„çª—å£ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰ï¼Œæ•°æ®åº“ä½¿ç”¨åŸºäºæ—¶é—´çš„çª—å£ï¼ˆæ…¢è°ƒç”¨ä¿æŠ¤ï¼‰ã€‚
2. **åˆç†é˜ˆå€¼**ï¼šå¤±è´¥ç‡é˜ˆå€¼è®¾ç½®ä¸º50%ï¼Œæ—¢ä¸è¿‡äºæ•æ„Ÿä¹Ÿä¸è¿‡äºè¿Ÿé’ã€‚
3. **å¼‚å¸¸åˆ†ç±»**ï¼šæ˜ç¡®æŒ‡å®š `recordExceptions` å’Œ `ignoreExceptions`ï¼Œé¿å…è¯¯åˆ¤ã€‚
4. **å¥åº·æ£€æŸ¥é›†æˆ**ï¼š`registerHealthIndicator: true` ä½¿ç†”æ–­çŠ¶æ€å¯é€šè¿‡ `/actuator/health` ç«¯ç‚¹ç›‘æ§ã€‚

### é™çº§ç­–ç•¥è®¾è®¡
åœ¨ `ShortUrlService` ä¸­å®ç°äº†ä¼˜é›…çš„é™çº§é€»è¾‘ï¼š

```java
@CircuitBreaker(name = "redisBreaker", fallbackMethod = "redisFallback")
@Retry(name = "redisRetry")
public String getLongUrlByShortCode(String shortCode) {
    // ä¼˜å…ˆæŸ¥è¯¢ L1 æœ¬åœ°ç¼“å­˜
    String cachedUrl = localCache.getIfPresent(shortCode);
    if (cachedUrl != null) {
        return cachedUrl;
    }
    
    // æŸ¥è¯¢ L2 Redis ç¼“å­˜
    String redisUrl = redisTemplate.opsForValue().get("short_url:" + shortCode);
    if (redisUrl != null) {
        localCache.put(shortCode, redisUrl);
        return redisUrl;
    }
    
    // å›æºæŸ¥è¯¢æ•°æ®åº“
    ShortUrl shortUrl = shortUrlRepository.findByShortCode(shortCode);
    if (shortUrl != null) {
        // å¼‚æ­¥å›å¡« Redis
        redisTemplate.opsForValue().set("short_url:" + shortCode, shortUrl.getLongUrl(), Duration.ofHours(24));
        localCache.put(shortCode, shortUrl.getLongUrl());
        return shortUrl.getLongUrl();
    }
    return null;
}

public String redisFallback(String shortCode, Throwable t) {
    log.error("[FALLBACK] Redis circuit breaker triggered for shortCode={}, reason={}", 
        shortCode, t.getMessage());
    // é™çº§é€»è¾‘ï¼šRedis æŒ‚äº†ç›´æ¥æŸ¥æ•°æ®åº“
    ShortUrl shortUrl = shortUrlRepository.findByShortCode(shortCode);
    if (shortUrl != null) {
        localCache.put(shortCode, shortUrl.getLongUrl());
        return shortUrl.getLongUrl();
    }
    return null;
}
```

**é™çº§ç­–ç•¥ç‰¹ç‚¹ï¼š**
- **å¤šçº§ç¼“å­˜**ï¼šL1ï¼ˆæœ¬åœ° Caffeineï¼‰â†’ L2ï¼ˆRedisï¼‰â†’ L3ï¼ˆæ•°æ®åº“ï¼‰
- **è‡ªåŠ¨å›å¡«**ï¼šæˆåŠŸæŸ¥è¯¢åè‡ªåŠ¨å›å¡«å„çº§ç¼“å­˜ï¼Œæé«˜åç»­æŸ¥è¯¢æ•ˆç‡
- **å¼‚æ­¥å›å¡«**ï¼šæ•°æ®åº“æŸ¥è¯¢æˆåŠŸåå¼‚æ­¥å›å¡« Redisï¼Œé¿å…é˜»å¡ä¸»æµç¨‹

**Section sources**
- [ShortUrlService.java](file://src/main/java/com/layor/tinyflow/service/ShortUrlService.java#L302-L365)

## é«˜è´Ÿè½½ä¸‹çš„ä¿æŠ¤æ•ˆæœåˆ†æ
ç³»ç»Ÿé€šè¿‡ `k6` å·¥å…·è¿›è¡Œäº† 5000 QPS çš„å‹åŠ›æµ‹è¯•ï¼ŒéªŒè¯ç†”æ–­é™çº§æœºåˆ¶çš„æœ‰æ•ˆæ€§ã€‚

### å‹æµ‹è„šæœ¬å…³é”®é…ç½®
```javascript
export const options = {
  scenarios: {
    stress_5000: {
      executor: 'ramping-arrival-rate',
      stages: [
        { target: 1000, duration: '30s' },
        { target: 2000, duration: '30s' },
        { target: 3000, duration: '30s' },
        { target: 5000, duration: '1m' },
        { target: 5000, duration: '2m' },
        { target: 1000, duration: '30s' },
      ],
    },
  },
  thresholds: {
    'http_req_duration': ['p(95)<100'],
    'http_req_failed': ['rate<0.05'],
  },
};
```

### ä¿æŠ¤æ•ˆæœ
1. **Redis æ•…éšœæ¨¡æ‹Ÿ**ï¼šå½“ Redis æœåŠ¡å®•æœºæ—¶ï¼Œ`redisBreaker` åœ¨çŸ­æ—¶é—´å†…ï¼ˆçº¦10æ¬¡è°ƒç”¨åï¼‰è¿›å…¥å¼€å¯çŠ¶æ€ï¼Œåç»­è¯·æ±‚ç›´æ¥æ‰§è¡Œé™çº§é€»è¾‘ï¼Œé¿å…äº†å¤§é‡è¶…æ—¶è¯·æ±‚å †ç§¯ã€‚
2. **æ•°æ®åº“æ…¢æŸ¥è¯¢**ï¼šå½“æ•°æ®åº“å“åº”æ—¶é—´è¶…è¿‡2ç§’æ—¶ï¼Œ`dbBreaker` è§¦å‘ç†”æ–­ï¼Œé˜²æ­¢æ…¢æŸ¥è¯¢æ‹–å®æ•´ä¸ªæœåŠ¡ã€‚
3. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šå³ä½¿åœ¨5000 QPSçš„é«˜è´Ÿè½½ä¸‹ï¼Œç³»ç»Ÿé€šè¿‡ç†”æ–­é™çº§æœºåˆ¶ä¿æŒäº†åŸºæœ¬å¯ç”¨æ€§ï¼Œé”™è¯¯ç‡æ§åˆ¶åœ¨5%ä»¥å†…ã€‚

## æ€§èƒ½å¼€é”€è¯„ä¼°
Resilience4j çš„æ€§èƒ½å¼€é”€ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

### è¿è¡Œæ—¶å¼€é”€
- **æ–¹æ³•ä»£ç†**ï¼šé€šè¿‡ AOP å®ç°çš„æ³¨è§£å¼ç†”æ–­ä¼šå¼•å…¥æ–¹æ³•è°ƒç”¨ä»£ç†å¼€é”€ï¼Œé€šå¸¸åœ¨å¾®ç§’çº§åˆ«ã€‚
- **çŠ¶æ€æ£€æŸ¥**ï¼šæ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€ï¼Œä½†çŠ¶æ€å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ€§èƒ½å½±å“æå°ã€‚
- **äº‹ä»¶å‘å¸ƒ**ï¼šçŠ¶æ€å˜æ›´äº‹ä»¶çš„å‘å¸ƒå’Œç›‘å¬ä¼šäº§ç”Ÿå°‘é‡å¯¹è±¡åˆ›å»ºå’Œçº¿ç¨‹åˆ‡æ¢å¼€é”€ã€‚

### èµ„æºå ç”¨
- **å†…å­˜**ï¼šæ¯ä¸ªç†”æ–­å™¨å®ä¾‹éœ€è¦å­˜å‚¨æ»‘åŠ¨çª—å£å†…çš„è°ƒç”¨è®°å½•ï¼Œ`eventConsumerBufferSize: 100` é™åˆ¶äº†å†…å­˜ä½¿ç”¨ã€‚
- **çº¿ç¨‹**ï¼šäº‹ä»¶ç›‘å¬åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸å½±å“ä¸»ä¸šåŠ¡çº¿ç¨‹ã€‚

### ç›‘æ§æŒ‡æ ‡
ç³»ç»Ÿé€šè¿‡ Micrometer æš´éœ²äº†è¯¦ç»†çš„ç†”æ–­å™¨æŒ‡æ ‡ï¼Œå¯é€šè¿‡ `/actuator/metrics` ç«¯ç‚¹æŸ¥çœ‹ï¼š
- `resilience4j.circuitbreaker.calls`ï¼šè°ƒç”¨ç»Ÿè®¡ï¼ˆæˆåŠŸã€å¤±è´¥ã€è¢«æ‹’ç»ç­‰ï¼‰
- `resilience4j.circuitbreaker.state`ï¼šç†”æ–­å™¨å½“å‰çŠ¶æ€
- `resilience4j.circuitbreaker.buffered.calls`ï¼šäº‹ä»¶ç¼“å†²åŒºå¤§å°

è¿™äº›æŒ‡æ ‡å¯ç”¨äºå®æ—¶ç›‘æ§ç†”æ–­å™¨çš„å¥åº·çŠ¶å†µå’Œæ€§èƒ½å½±å“ã€‚

## æ€»ç»“
TinyFlow ç³»ç»Ÿé€šè¿‡ Resilience4j å®ç°äº†å®Œå–„çš„ç†”æ–­é™çº§æœºåˆ¶ï¼Œæœ‰æ•ˆä¿æŠ¤äº†å…³é”®ä¾èµ–æœåŠ¡ã€‚æ ¸å¿ƒè¦ç‚¹åŒ…æ‹¬ï¼š
1. **å¤šç»´åº¦ä¿æŠ¤**ï¼šç»“åˆç†”æ–­å™¨ã€é™æµå™¨ã€é‡è¯•å’Œèˆ±å£éš”ç¦»ï¼Œæ„å»ºäº†å¤šå±‚æ¬¡çš„å®¹é”™ä½“ç³»ã€‚
2. **å·®å¼‚åŒ–é…ç½®**ï¼šæ ¹æ® Redis å’Œæ•°æ®åº“çš„ä¸åŒç‰¹æ€§ï¼Œé…ç½®äº†é’ˆå¯¹æ€§çš„ç†”æ–­ç­–ç•¥ã€‚
3. **ä¼˜é›…é™çº§**ï¼šå®ç°äº†ä»æœ¬åœ°ç¼“å­˜åˆ°æ•°æ®åº“çš„å¤šçº§é™çº§ç­–ç•¥ï¼Œä¿è¯äº†æœåŠ¡çš„åŸºæœ¬å¯ç”¨æ€§ã€‚
4. **å¯è§‚æµ‹æ€§**ï¼šé€šè¿‡äº‹ä»¶ç›‘å¬å’ŒæŒ‡æ ‡æš´éœ²ï¼Œå®ç°äº†ç†”æ–­çŠ¶æ€çš„å…¨é¢ç›‘æ§ã€‚
5. **é«˜è´Ÿè½½ä¿æŠ¤**ï¼šåœ¨5000 QPSçš„å‹åŠ›æµ‹è¯•ä¸­ï¼Œç³»ç»Ÿé€šè¿‡ç†”æ–­é™çº§æœºåˆ¶ä¿æŒäº†ç¨³å®šè¿è¡Œã€‚

è¯¥ç†”æ–­é™çº§æœºåˆ¶æ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®¹é”™èƒ½åŠ›ï¼Œæ˜¯ TinyFlow èƒ½å¤Ÿåº”å¯¹é«˜å¹¶å‘åœºæ™¯çš„å…³é”®ä¿éšœã€‚