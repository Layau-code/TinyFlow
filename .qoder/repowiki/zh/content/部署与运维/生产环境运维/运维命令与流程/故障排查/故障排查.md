# 故障排查

<cite>
**本文档引用的文件**  
- [OPERATIONS.md](file://OPERATIONS.md)
- [application.yml](file://src/main/resources/application.yml)
- [TinyFlowApplication.java](file://src/main/java/com/layor/tinyflow/TinyFlowApplication.java)
- [logback-spring.xml](file://src/main/resources/logback-spring.xml)
- [SecurityConfig.java](file://src/main/java/com/layor/tinyflow/config/SecurityConfig.java)
- [CacheConfig.java](file://src/main/java/com/layor/tinyflow/config/CacheConfig.java)
- [WebConfig.java](file://src/main/java/com/layor/tinyflow/config/WebConfig.java)
- [Dockerfile](file://Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [deploy.sh](file://deploy.sh)
</cite>

## 目录

1. [服务无法启动](#服务无法启动)  
2. [数据库连接失败](#数据库连接失败)  
3. [Redis连接失败](#redis连接失败)  
4. [前端访问失败](#前端访问失败)  
5. [预防性检查建议](#预防性检查建议)

## 服务无法启动

当执行 `systemctl start tinyflow` 后服务无法正常启动时，应按照以下系统化流程进行排查。

### 1. 查看详细启动日志

使用 `journalctl` 工具查看服务的详细错误输出，这是定位问题的第一步。

```bash
journalctl -u tinyflow -n 50 --no-pager
```

重点关注日志中的 `ERROR`、`Exception` 或 `Caused by` 字样，这些通常指向根本原因。

### 2. 检查端口占用情况

后端服务默认监听 8080 端口。如果该端口被其他进程占用，服务将无法启动。

```bash
netstat -tlnp | grep 8080
```

如果发现端口被占用，可通过 `kill <PID>` 终止占用进程，或修改服务配置使用其他端口。

### 3. 验证服务配置文件

检查 systemd 服务配置文件是否正确，特别是 Java 启动参数和 JAR 路径。

```bash
cat /etc/systemd/system/tinyflow.service
```

确认 `ExecStart` 中的 JAR 路径是否存在，以及环境变量（如数据库密码、Redis密码、JWT密钥）是否正确传递。

### 4. 手动运行 JAR 包测试

进入部署目录，尝试直接运行 JAR 包，以排除 systemd 配置问题。

```bash
cd /opt/tinyflow
java -jar app.jar
```

如果手动运行报错，说明问题出在应用本身或其依赖项，而非服务管理器。

### 5. 检查系统资源

内存或磁盘空间不足也可能导致服务无法启动。

```bash
free -h  # 检查内存
df -h    # 检查磁盘
```

确保系统有足够的内存（建议至少 1GB 可用）和磁盘空间。

**Section sources**
- [OPERATIONS.md](file://OPERATIONS.md#L163-L182)
- [deploy.sh](file://deploy.sh#L430-L460)
- [Dockerfile](file://Dockerfile#L5)

## 数据库连接失败

当应用无法连接 MySQL 数据库时，按以下步骤排查。

### 1. 检查 MySQL 服务状态

首先确认 MySQL 服务是否正在运行。

```bash
systemctl status mysql
```

如果服务未运行，尝试启动：

```bash
systemctl start mysql
```

### 2. 测试数据库连接

使用命令行客户端测试能否连接到数据库。

```bash
mysql -u tinyflow -p tiny-flow
```

输入密码后，若无法登录，检查用户名、密码和数据库名是否正确。

### 3. 查看数据库日志

MySQL 错误日志通常包含详细的连接失败原因。

```bash
tail -f /var/log/mysql/error.log
```

常见问题包括：用户权限不足、连接数超限、SSL 配置问题等。

### 4. 检查数据库用户权限

登录 MySQL root 账户，检查应用用户权限。

```bash
mysql -u root -p
SHOW GRANTS FOR 'tinyflow'@'localhost';
```

确保用户拥有对 `tiny-flow` 数据库的全部权限。

### 5. 验证应用配置

检查 `application.yml` 或环境变量中的数据库连接配置。

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/tiny-flow
    username: tinyflow
    password: ${DB_PASSWORD}
```

确保 `DB_PASSWORD` 环境变量已正确设置。

**Section sources**
- [OPERATIONS.md](file://OPERATIONS.md#L184-L200)
- [application.yml](file://src/main/resources/application.yml#L4-L8)
- [docker-compose.yml](file://docker-compose.yml#L10-L21)

## Redis连接失败

Redis 连接失败会影响缓存、限流和会话等功能。

### 1. 检查 Redis 服务状态

确认 Redis 服务是否正在运行。

```bash
systemctl status redis
```

如果未运行，尝试启动：

```bash
systemctl start redis
```

### 2. 测试 Redis 连接

使用 `redis-cli` 测试连接和认证。

```bash
redis-cli -a 123456 ping
```

如果返回 `PONG`，表示连接成功；否则检查密码或服务状态。

### 3. 查看 Redis 日志

查看 Redis 的运行日志以获取错误信息。

```bash
journalctl -u redis -n 50
```

### 4. 检查 Redis 配置

确认 Redis 配置文件中的密码和绑定地址。

```bash
grep -E "requirepass|bind" /etc/redis/redis.conf
```

确保 `requirepass` 设置正确，且 `bind` 允许本地连接。

### 5. 验证应用配置

检查应用配置中的 Redis 连接信息。

```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      password: ${REDIS_PASSWORD}
```

确保 `REDIS_PASSWORD` 环境变量已正确设置。

**Section sources**
- [OPERATIONS.md](file://OPERATIONS.md#L202-L216)
- [application.yml](file://src/main/resources/application.yml#L22-L25)
- [docker-compose.yml](file://docker-compose.yml#L2-L9)

## 前端访问失败

当用户无法访问前端页面时，按以下流程排查。

### 1. 检查 Nginx 服务状态

确认 Nginx 是否正在运行。

```bash
systemctl status nginx
```

如果未运行，尝试启动：

```bash
systemctl start nginx
```

### 2. 测试 Nginx 配置

检查 Nginx 配置文件语法是否正确。

```bash
nginx -t
```

语法错误会导致服务无法启动。

### 3. 检查前端文件是否存在

确认前端构建产物已正确部署。

```bash
ls -lh /opt/TinyFlow/web/dist/
```

确保 `index.html` 和静态资源文件存在。

### 4. 查看 Nginx 错误日志

Nginx 错误日志可提供访问失败的具体原因。

```bash
tail -f /var/log/nginx/error.log
```

常见问题包括：文件不存在、权限不足、代理失败等。

### 5. 测试后端 API 连通性

即使前端无法访问，也应测试后端 API 是否正常。

```bash
curl http://localhost:8080/api/auth/login -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'
```

如果 API 正常，问题可能出在 Nginx 配置或前端代码。

**Section sources**
- [OPERATIONS.md](file://OPERATIONS.md#L218-L237)
- [deploy.sh](file://deploy.sh#L362-L427)
- [web/package.json](file://web/package.json)

## 预防性检查建议

为避免常见故障，建议定期执行以下预防性检查。

### 1. 服务状态健康检查

定期检查所有关键服务的运行状态。

```bash
systemctl status tinyflow nginx mysql redis
```

确保所有服务均处于 `active (running)` 状态。

### 2. 磁盘与内存监控

定期检查系统资源使用情况。

```bash
df -h && free -h
```

设置磁盘使用率超过 80% 时的告警。

### 3. 日志轮转与清理

定期清理旧日志，防止磁盘被占满。

```bash
journalctl --vacuum-time=7d
echo > /var/log/nginx/access.log
echo > /var/log/nginx/error.log
```

### 4. 数据库与 Redis 备份

定期备份关键数据。

```bash
# 数据库备份
mysqldump -u root -p123456 tiny-flow > /root/backup/tinyflow_$(date +%Y%m%d).sql

# Redis 备份
cp /var/lib/redis/dump.rdb /root/backup/redis_$(date +%Y%m%d).rdb
```

### 5. 防火墙与安全组检查

确保防火墙配置正确，仅开放必要端口。

```bash
ufw status
```

禁止外部直接访问数据库（3306）、Redis（6379）和后端服务（8080）。