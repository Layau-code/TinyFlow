# ç†”æ–­ç›‘æ§

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**  
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java)
- [PerformanceMonitorAspect.java](file://src/main/java/com/layor/tinyflow/aspect/PerformanceMonitorAspect.java)
- [application.yml](file://src/main/resources/application.yml)
- [ShortUrlService.java](file://src/main/java/com/layor/tinyflow/service/ShortUrlService.java)
- [MonitorController.java](file://src/main/java/com/layor/tinyflow/Controller/MonitorController.java)
- [ObservabilityConfig.java](file://src/main/java/com/layor/tinyflow/config/ObservabilityConfig.java)
- [CacheConfig.java](file://src/main/java/com/layor/tinyflow/config/CacheConfig.java)
- [prometheus.yml](file://web/infra/observability/prometheus.yml)
- [shortener-overview.json](file://web/infra/observability/dashboards/shortener-overview.json)
- [OBSERVABILITY.md](file://OBSERVABILITY.md)
- [logback-spring.xml](file://src/main/resources/logback-spring.xml)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [ç†”æ–­å™¨æŒ‡æ ‡ç›‘æ§](#ç†”æ–­å™¨æŒ‡æ ‡ç›‘æ§)
3. [Prometheusä¸Grafanaé›†æˆ](#prometheusä¸grafanaé›†æˆ)
4. [å‘Šè­¦é…ç½®å»ºè®®](#å‘Šè­¦é…ç½®å»ºè®®)
5. [ç›‘æ§ç»„ä»¶åˆ†æ](#ç›‘æ§ç»„ä»¶åˆ†æ)
6. [æ—¥å¿—æ’æŸ¥ä¸é—®é¢˜å®šä½](#æ—¥å¿—æ’æŸ¥ä¸é—®é¢˜å®šä½)
7. [æ€»ç»“](#æ€»ç»“)

## å¼•è¨€
æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•é€šè¿‡Resilience4jçš„æŒ‡æ ‡ç«¯ç‚¹æ¥ç›‘æ§`redisBreaker`çš„çŠ¶æ€ï¼Œå¹¶å°†è¿™äº›æŒ‡æ ‡é›†æˆåˆ°Prometheuså’ŒGrafanaä¸­ï¼Œåˆ›å»ºå¯è§†åŒ–ä»ªè¡¨ç›˜ã€‚åŒæ—¶æä¾›å‘Šè­¦é…ç½®å»ºè®®ï¼Œå¹¶åˆ†æ`PerformanceMonitorAspect`å’Œ`CircuitBreakerEventListener`åœ¨ç›‘æ§ä¸­çš„ä½œç”¨ã€‚

## ç†”æ–­å™¨æŒ‡æ ‡ç›‘æ§
é€šè¿‡Spring Boot Actuatoræä¾›çš„`/actuator/circuitbreakers`ç«¯ç‚¹å¯ä»¥è·å–ç†”æ–­å™¨çš„è¯¦ç»†çŠ¶æ€ä¿¡æ¯ã€‚ç³»ç»Ÿä¸­é…ç½®äº†ä¸¤ä¸ªä¸»è¦ç†”æ–­å™¨ï¼š`redisBreaker`å’Œ`dbBreaker`ã€‚

`redisBreaker`çš„å…³é”®é…ç½®å¦‚ä¸‹ï¼š
- **æ»‘åŠ¨çª—å£ç±»å‹**ï¼šåŸºäºè¯·æ±‚æ•°ï¼ˆCOUNT_BASEDï¼‰
- **æ»‘åŠ¨çª—å£å¤§å°**ï¼š100æ¬¡è¯·æ±‚
- **æœ€å°è°ƒç”¨æ¬¡æ•°**ï¼š10æ¬¡
- **å¤±è´¥ç‡é˜ˆå€¼**ï¼š50%
- **æ…¢è°ƒç”¨ç‡é˜ˆå€¼**ï¼š80%ï¼ˆè¶…è¿‡1ç§’è§†ä¸ºæ…¢è°ƒç”¨ï¼‰
- **æ‰“å¼€çŠ¶æ€ç­‰å¾…æ—¶é—´**ï¼š30ç§’

å¯ä»¥é€šè¿‡è®¿é—®`/actuator/circuitbreakers`ç«¯ç‚¹æŸ¥çœ‹æ‰€æœ‰ç†”æ–­å™¨çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å½“å‰çŠ¶æ€ã€å¤±è´¥ç‡ã€æ…¢è°ƒç”¨ç‡ç­‰å…³é”®æŒ‡æ ‡ã€‚

**Section sources**
- [application.yml](file://src/main/resources/application.yml#L158-L175)
- [OBSERVABILITY.md](file://OBSERVABILITY.md#L7-L11)

## Prometheusä¸Grafanaé›†æˆ
ç³»ç»Ÿå·²é…ç½®Micrometerä¸Prometheusé›†æˆï¼Œæ‰€æœ‰æŒ‡æ ‡å¯é€šè¿‡`/actuator/prometheus`ç«¯ç‚¹æš´éœ²ã€‚

Prometheusé…ç½®æ–‡ä»¶`prometheus.yml`ä¸­å®šä¹‰äº†æŠ“å–ä»»åŠ¡ï¼š
```yaml
scrape_configs:
  - job_name: 'tinyflow-backend'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['host.docker.internal:8080']
```

Grafanaä»ªè¡¨ç›˜`shortener-overview.json`åŒ…å«äº†å¤šä¸ªå…³é”®é¢æ¿ï¼š
- **è¯·æ±‚ååé‡**ï¼šå®æ—¶QPS
- **å“åº”å»¶è¿Ÿ**ï¼šP50/P95/P99
- **é”™è¯¯ç‡**ï¼š5xxçŠ¶æ€ç æ¯”ä¾‹
- **é‡å®šå‘å»¶è¿Ÿ**ï¼šP95

```mermaid
graph TB
subgraph "ç›‘æ§ä½“ç³»"
Prometheus["Prometheus (æŒ‡æ ‡é‡‡é›†)"]
Grafana["Grafana (å¯è§†åŒ–)"]
Application["åº”ç”¨ (TinyFlow)"]
end
Application --> |/actuator/prometheus| Prometheus
Prometheus --> |æ•°æ®æº| Grafana
Grafana --> |ä»ªè¡¨ç›˜| User["è¿ç»´äººå‘˜"]
style Application fill:#4CAF50,stroke:#388E3C
style Prometheus fill:#E91E63,stroke:#C2185B
style Grafana fill:#2196F3,stroke:#1976D2
```

**Diagram sources**
- [prometheus.yml](file://web/infra/observability/prometheus.yml#L5-L9)
- [shortener-overview.json](file://web/infra/observability/dashboards/shortener-overview.json#L1-L55)

**Section sources**
- [prometheus.yml](file://web/infra/observability/prometheus.yml#L1-L9)
- [shortener-overview.json](file://web/infra/observability/dashboards/shortener-overview.json#L1-L55)
- [ObservabilityConfig.java](file://src/main/java/com/layor/tinyflow/config/ObservabilityConfig.java#L18-L24)

## å‘Šè­¦é…ç½®å»ºè®®
å½“ç†”æ–­å™¨è¿›å…¥OPENçŠ¶æ€æ—¶ï¼Œåº”ç«‹å³è§¦å‘å‘Šè­¦ã€‚ä»¥ä¸‹æ˜¯æ¨èçš„å‘Šè­¦è§„åˆ™ï¼š

1. **ç†”æ–­å™¨æ‰“å¼€å‘Šè­¦**ï¼š
   ```
   resilience4j_circuitbreaker_state{state="open"} == 1
   ```

2. **é«˜é”™è¯¯ç‡å‘Šè­¦**ï¼š
   ```
   rate(http_server_requests_seconds_count{status=~"5.."}[1m]) > 0.01
   ```

3. **é«˜å»¶è¿Ÿå‘Šè­¦**ï¼š
   ```
   http_server_requests_seconds{quantile="0.95"} > 0.1
   ```

4. **ä½ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦**ï¼š
   ```
   caffeine_cache_hit_total / (caffeine_cache_hit_total + caffeine_cache_miss_total) < 0.9
   ```

è¿™äº›å‘Šè­¦è§„åˆ™å¯ä»¥åœ¨Prometheus Alertmanageræˆ–Grafanaä¸­é…ç½®ï¼Œé€šè¿‡é‚®ä»¶ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰æ–¹å¼é€šçŸ¥ç›¸å…³äººå‘˜ã€‚

**Section sources**
- [OBSERVABILITY.md](file://OBSERVABILITY.md#L214-L218)

## ç›‘æ§ç»„ä»¶åˆ†æ

### CircuitBreakerEventListeneråˆ†æ
`CircuitBreakerEventListener`ç±»è´Ÿè´£ç›‘å¬ç†”æ–­å™¨çš„çŠ¶æ€å˜åŒ–äº‹ä»¶ï¼Œå¹¶è®°å½•ç›¸åº”çš„æ—¥å¿—ã€‚

ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
- ç›‘å¬ç†”æ–­å™¨çŠ¶æ€è½¬æ¢äº‹ä»¶
- å½“ç†”æ–­å™¨è¿›å…¥OPENçŠ¶æ€æ—¶è®°å½•é”™è¯¯æ—¥å¿—å¹¶è§¦å‘å‘Šè­¦
- å½“ç†”æ–­å™¨æ¢å¤åˆ°CLOSEDçŠ¶æ€æ—¶è®°å½•æ¢å¤æ—¥å¿—

```mermaid
sequenceDiagram
participant CB as "CircuitBreaker"
participant Listener as "CircuitBreakerEventListener"
participant Log as "æ—¥å¿—ç³»ç»Ÿ"
CB->>Listener : onStateTransition(event)
Listener->>Listener : è§£æäº‹ä»¶çŠ¶æ€
alt çŠ¶æ€å˜ä¸ºOPEN
Listener->>Log : è®°å½•é”™è¯¯æ—¥å¿—(ğŸ”´ ALERT)
else çŠ¶æ€å˜ä¸ºCLOSED
Listener->>Log : è®°å½•ä¿¡æ¯æ—¥å¿—(ğŸŸ¢ æ¢å¤)
else å…¶ä»–çŠ¶æ€è½¬æ¢
Listener->>Log : è®°å½•è­¦å‘Šæ—¥å¿—(âš¡ çŠ¶æ€å˜åŒ–)
end
```

**Diagram sources**
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java#L37-L57)

**Section sources**
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java#L1-L57)

### PerformanceMonitorAspectåˆ†æ
`PerformanceMonitorAspect`æ˜¯ä¸€ä¸ªAOPåˆ‡é¢ï¼Œç”¨äºç›‘æ§Controllerå’ŒServiceå±‚çš„æ–¹æ³•æ‰§è¡Œæ€§èƒ½ã€‚

å…³é”®ç‰¹æ€§ï¼š
- ç›‘æ§æ‰€æœ‰Controllerå’ŒServiceå±‚æ–¹æ³•
- å®šä¹‰100msä¸ºæ…¢è¯·æ±‚é˜ˆå€¼
- æ…¢è¯·æ±‚æ—¥å¿—è¾“å‡ºåˆ°ç‹¬ç«‹çš„performance.logæ–‡ä»¶
- è®°å½•æ–¹æ³•æ‰§è¡Œæ—¶é—´ã€å¼‚å¸¸ç­‰ä¿¡æ¯

```mermaid
flowchart TD
Start([æ–¹æ³•è°ƒç”¨å¼€å§‹]) --> RecordTime["è®°å½•å¼€å§‹æ—¶é—´"]
RecordTime --> ExecuteMethod["æ‰§è¡Œç›®æ ‡æ–¹æ³•"]
ExecuteMethod --> CheckDuration["æ£€æŸ¥æ‰§è¡Œæ—¶é•¿"]
CheckDuration --> |æ—¶é•¿ > 100ms| LogSlow["è®°å½•æ…¢è¯·æ±‚æ—¥å¿—"]
CheckDuration --> |æ—¶é•¿ â‰¤ 100ms| LogNormal["è®°å½•æ­£å¸¸æ—¥å¿—"]
ExecuteMethod --> |å‘ç”Ÿå¼‚å¸¸| LogError["è®°å½•é”™è¯¯æ—¥å¿—"]
LogSlow --> End([æ–¹æ³•ç»“æŸ])
LogNormal --> End
LogError --> End
```

**Diagram sources**
- [PerformanceMonitorAspect.java](file://src/main/java/com/layor/tinyflow/aspect/PerformanceMonitorAspect.java#L40-L63)

**Section sources**
- [PerformanceMonitorAspect.java](file://src/main/java/com/layor/tinyflow/aspect/PerformanceMonitorAspect.java#L1-L64)

## æ—¥å¿—æ’æŸ¥ä¸é—®é¢˜å®šä½
ç³»ç»Ÿæä¾›äº†å¤šå±‚æ¬¡çš„æ—¥å¿—æœºåˆ¶ç”¨äºé—®é¢˜æ’æŸ¥ï¼š

### ç†”æ–­ç›¸å…³æ—¥å¿—
- **çŠ¶æ€å˜åŒ–æ—¥å¿—**ï¼šä½¿ç”¨`âš¡`æ ‡è¯†ç†”æ–­å™¨çŠ¶æ€å˜åŒ–
- **æ‰“å¼€çŠ¶æ€å‘Šè­¦**ï¼šä½¿ç”¨`ğŸ”´ ALERT`æ ‡è¯†ç†”æ–­å™¨æ‰“å¼€
- **æ¢å¤çŠ¶æ€æ—¥å¿—**ï¼šä½¿ç”¨`ğŸŸ¢`æ ‡è¯†ç³»ç»Ÿæ¢å¤

å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ç†”æ–­å™¨ç›¸å…³æ—¥å¿—ï¼š
```bash
grep "CircuitBreaker" logs/tinyflow.log
```

### é™çº§æ—¥å¿—
å½“ç†”æ–­å™¨è§¦å‘é™çº§æ—¶ï¼Œä¼šè®°å½•å¸¦æœ‰`[FALLBACK]`å‰ç¼€çš„æ—¥å¿—ï¼š
```java
log.error("[FALLBACK] Redis circuit breaker triggered for shortCode={}, reason={}", 
    shortCode, t.getMessage());
```

è¿™äº›æ—¥å¿—å¯ä»¥å¸®åŠ©å¿«é€Ÿå®šä½æ˜¯å“ªä¸ªçŸ­ç çš„RedisæŸ¥è¯¢å¤±è´¥ï¼Œä»¥åŠå¤±è´¥çš„å…·ä½“åŸå› ã€‚

### æ€§èƒ½æ—¥å¿—
æ…¢è¯·æ±‚ä¼šè¢«è®°å½•åˆ°ç‹¬ç«‹çš„`performance.log`æ–‡ä»¶ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```
[LAYER] SLOW - METHOD_NAME took DURATIONms
```

å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›‘æ§æ…¢è¯·æ±‚ï¼š
```bash
tail -f logs/performance.log
```

**Section sources**
- [CircuitBreakerEventListener.java](file://src/main/java/com/layor/tinyflow/listener/CircuitBreakerEventListener.java#L41-L54)
- [PerformanceMonitorAspect.java](file://src/main/java/com/layor/tinyflow/aspect/PerformanceMonitorAspect.java#L50-L52)
- [ShortUrlService.java](file://src/main/java/com/layor/tinyflow/service/ShortUrlService.java#L355-L365)
- [logback-spring.xml](file://src/main/resources/logback-spring.xml#L47-L58)

## æ€»ç»“
æœ¬ç³»ç»Ÿé€šè¿‡Resilience4jã€Micrometerã€Prometheuså’ŒGrafanaæ„å»ºäº†å®Œæ•´çš„ç†”æ–­ç›‘æ§ä½“ç³»ã€‚`redisBreaker`çš„çŠ¶æ€å¯ä»¥é€šè¿‡`/actuator/circuitbreakers`ç«¯ç‚¹å®æ—¶ç›‘æ§ï¼Œå…³é”®æŒ‡æ ‡å·²é›†æˆåˆ°Grafanaä»ªè¡¨ç›˜ä¸­ã€‚å½“ç†”æ–­å™¨è¿›å…¥OPENçŠ¶æ€æ—¶ï¼Œ`CircuitBreakerEventListener`ä¼šè®°å½•å‘Šè­¦æ—¥å¿—ï¼ŒåŒæ—¶`PerformanceMonitorAspect`æä¾›äº†ç»†ç²’åº¦çš„æ€§èƒ½ç›‘æ§èƒ½åŠ›ã€‚é€šè¿‡[FALLBACK]å‰ç¼€çš„æ—¥å¿—å¯ä»¥å¿«é€Ÿå®šä½é™çº§é—®é¢˜ï¼Œä¸ºç³»ç»Ÿçš„ç¨³å®šè¿è¡Œæä¾›äº†æœ‰åŠ›ä¿éšœã€‚

**Section sources**
- [OBSERVABILITY.md](file://OBSERVABILITY.md#L222-L240)