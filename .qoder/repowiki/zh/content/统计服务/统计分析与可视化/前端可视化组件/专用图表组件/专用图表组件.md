# 专用图表组件

<cite>
**本文档中引用的文件**   
- [TrendLineChart.vue](file://web/src/components/charts/TrendLineChart.vue)
- [DevicePieChart.vue](file://web/src/components/charts/DevicePieChart.vue)
- [BrowserOSChart.vue](file://web/src/components/charts/BrowserOSChart.vue)
- [CityBarChart.vue](file://web/src/components/charts/CityBarChart.vue)
- [SourceHBarChart.vue](file://web/src/components/charts/SourceHBarChart.vue)
- [HeatmapChart.vue](file://web/src/components/charts/HeatmapChart.vue)
- [EChartsPie.vue](file://web/src/components/charts/EChartsPie.vue)
- [StatsPage.vue](file://web/src/pages/StatsPage.vue)
</cite>

## 目录
1. [简介](#简介)
2. [趋势折线图组件](#趋势折线图组件)
3. [设备与浏览器分布图组件](#设备与浏览器分布图组件)
4. [横向柱状图组件](#横向柱状图组件)
5. [小时热度图组件](#小时热度图组件)
6. [在统计页面中的集成](#在统计页面中的集成)

## 简介
本项目包含一组专用于前端数据可视化的图表组件，旨在为短链统计系统提供直观、美观的数据展示功能。这些组件覆盖了时间趋势分析、设备与浏览器分布、城市与来源统计以及小时访问热度等多种数据可视化需求。所有组件均基于Vue 3的组合式API构建，采用响应式设计，能够适应不同屏幕尺寸，并提供良好的用户体验。

## 趋势折线图组件

`TrendLineChart` 组件用于渲染时间趋势折线图，通过SVG原生绘制实现轻量级的图表展示。该组件接收时间序列数据并将其可视化为折线图，适用于展示访问量随时间变化的趋势。

### Props 定义
- `values`: 数值数组，表示每个时间点的访问量或指标值
- `labels`: 标签数组，对应每个数据点的时间标签（如日期）
- `width`: 图表宽度，默认600像素
- `height`: 图表高度，默认220像素
- `color`: 折线颜色，默认为`#4F46E5`

### 渲染逻辑
组件使用SVG的`<polyline>`元素绘制折线，并在每个数据点上绘制圆形标记。通过计算每个点的坐标位置，将原始数据映射到SVG坐标系中。Y轴采用反向比例，确保数值越大在图表中位置越高。

### 响应式更新
组件利用Vue的`computed`属性实现响应式更新：
- `maxVal`: 计算数据中的最大值，用于确定Y轴比例
- `stepX`: 计算X轴上每个数据点之间的间距
- `scaled`: 计算每个数据点在SVG坐标系中的实际坐标
- `pointsAttr`: 将坐标数组转换为SVG所需的点字符串格式

当输入数据变化时，所有计算属性自动更新，触发视图重新渲染。

**Section sources**
- [TrendLineChart.vue](file://web/src/components/charts/TrendLineChart.vue#L1-L38)

## 设备与浏览器分布图组件

本节介绍基于ECharts的饼图组件及其具体应用，包括设备分布和浏览器/操作系统分布的实现。

### EChartsPie 基础组件

`EChartsPie` 是一个通用的环形/饼图基础组件，封装了ECharts库的核心功能，提供了统一的API接口。

#### 实例化过程
组件在`onMounted`生命周期中异步加载ECharts库，并初始化图表实例。使用`ResizeObserver`监听容器尺寸变化，确保图表的响应式特性。

#### 数据映射
接收`data`属性，格式为`{ label: string, value: number }`对象数组。组件自动过滤无效数据，并计算总和以确定各部分占比。

#### 颜色配置
支持通过`colors`属性自定义配色方案，若未提供则使用预设的紫色系渐变色板。

#### 图例交互
配置垂直图例位于右侧，支持鼠标悬停高亮对应扇区，并显示详细数值和百分比。

**Section sources**
- [EChartsPie.vue](file://web/src/components/charts/EChartsPie.vue#L1-L126)

### DevicePieChart 组件

`DevicePieChart` 组件专门用于展示设备分布情况，包括iOS、Android和PC三种设备类型。

#### 数据结构
接收`data`对象，包含`ios`、`android`、`pc`三个属性，分别表示各设备类型的访问次数。

#### 环形图实现
使用SVG的`<circle>`元素通过`stroke-dasharray`和`stroke-dashoffset`属性实现环形进度条效果，三个圆环叠加形成类似饼图的视觉效果。

#### 颜色与标签
- iOS: 紫色 `#4F46E5`
- Android: 紫罗兰色 `#7C3AED`
- PC: 青色 `#06B6D4`

右侧显示详细数据标签，包含颜色标识、设备名称和访问次数。

**Section sources**
- [DevicePieChart.vue](file://web/src/components/charts/DevicePieChart.vue#L1-L55)

### BrowserOSChart 组件

`BrowserOSChart` 组件用于展示浏览器和操作系统的分布情况，采用标签页形式切换视图。

#### 数据解析
组件从用户代理字符串（User Agent）中解析浏览器和操作系统信息：
- 浏览器识别：Chrome、Safari、Firefox、Edge、Opera、IE等
- 操作系统识别：Windows、macOS、Linux、Android、iOS等

#### 双标签页设计
- **浏览器分布**: 按访问次数排序显示前8个浏览器
- **操作系统分布**: 按访问次数排序显示前8个操作系统

#### 可视化方式
采用横向条形图形式，每个条目包含：
- 图标：使用emoji表情符号表示浏览器或操作系统
- 名称：显示浏览器或操作系统名称
- 访问次数：显示具体数值
- 百分比：显示占总访问量的百分比
- 进度条：长度表示相对占比，颜色为渐变填充

**Section sources**
- [BrowserOSChart.vue](file://web/src/components/charts/BrowserOSChart.vue#L1-L308)

## 横向柱状图组件

本节介绍两种横向柱状图组件的实现方式和配置特点。

### CityBarChart 组件

`CityBarChart` 组件用于展示城市访问量的TOP分布。

#### 坐标轴配置
采用CSS Grid布局，创建5列等宽网格，每个城市占据一列。Y轴通过div元素的高度表示访问量大小。

#### 数据排序
数据按访问量降序排列，确保排名靠前的城市在图表中位置更突出。

#### 标签显示
每个柱状图下方显示城市名称（截断显示），柱状图上方显示具体访问次数。

#### 高度计算
使用`barHeight`函数计算柱状图高度，基于最大值进行归一化处理，并添加固定偏移量确保最小可见高度。

**Section sources**
- [CityBarChart.vue](file://web/src/components/charts/CityBarChart.vue#L1-L21)

### SourceHBarChart 组件

`SourceHBarChart` 组件用于展示来源域名的分布情况。

#### 布局结构
使用垂直堆叠的布局，每个来源占据一行，包含标签行和进度条。

#### 进度条配置
- 外层容器：灰色背景，圆角边框
- 内层填充：靛蓝色，宽度根据占比动态计算
- 高度固定为3像素，保持紧凑布局

#### 数据排序
数据按访问量降序排列，确保主要来源在上方显示。

#### 标签显示
每行包含来源域名（左侧，灰色）、访问次数（右侧，深色）和百分比（右侧，次级颜色）。

**Section sources**
- [SourceHBarChart.vue](file://web/src/components/charts/SourceHBarChart.vue#L1-L23)

## 小时热度图组件

`HeatmapChart` 组件用于可视化24小时访问热力图，展示全天各时段的访问密度。

### 二维数据结构
组件接收事件数据数组，每个事件包含时间戳`ts`。通过`hours`计算属性将原始数据转换为24小时的访问量分布：
- 初始化24小时的Map，初始值为0
- 遍历所有事件，提取小时部分并累加计数
- 转换为`{ hour: number, value: number }`对象数组

### 颜色渐变
根据访问量强度应用不同的颜色：
- 低强度（<25%）：浅蓝色 `rgba(59, 130, 246, opacity)`
- 中强度（25-50%）：中蓝色 `rgba(37, 99, 235, opacity)`
- 高强度（50-75%）：紫色 `rgba(147, 51, 234, opacity)`
- 极高强度（>75%）：红色 `rgba(239, 68, 68, opacity)`

透明度随强度增加，范围从0.2到1.0。

### 时间轴处理
- X轴：Grid布局自动排列24个时间单元格
- Y轴：无显式Y轴，通过颜色强度表示数值大小
- 时间标签：格式化为"HH:00"形式显示在每个单元格内

### 交互特性
- 悬停效果：放大并添加阴影，提升可点击性
- 响应式设计：在移动设备上调整网格密度和字体大小

**Section sources**
- [HeatmapChart.vue](file://web/src/components/charts/HeatmapChart.vue#L1-L242)

## 在统计页面中的集成

`StatsPage.vue` 是这些图表组件的主要集成页面，展示了如何将各个专用图表组件组合成完整的统计仪表板。

### 组件布局
页面采用网格布局，根据不同屏幕尺寸调整图表排列：
- 趋势图表：占据整行宽度
- 分布图表：两列布局，便于对比分析
- 列表类图表：两列布局，最大化空间利用率

### 数据流管理
通过`useFetchTrend`、`useFetchDistribution`等组合式函数管理API请求，将获取的数据转换为各图表组件所需的格式。

### 交互集成
- 时间范围选择：7天、14天、30天选项触发趋势图数据刷新
- 筛选功能：弹出式筛选面板允许用户按日期、来源、设备等条件过滤数据
- 导出功能：支持将统计数据导出为CSV格式

### 异常处理
- 空状态：当无数据时显示"暂无数据"提示
- 加载状态：显示旋转动画表示数据加载中
- 错误处理：捕获API请求异常并记录到控制台

**Section sources**
- [StatsPage.vue](file://web/src/pages/StatsPage.vue#L1-L954)