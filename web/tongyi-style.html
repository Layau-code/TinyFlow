<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyFlow - 短链生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* 深色导航栏 */
        .navbar {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 16px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 24px;
            font-size: 14px;
            opacity: 0.8;
        }

        /* 主容器 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 24px 60px;
        }

        /* 标题区域 */
        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .main-title {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 18px;
            color: #666;
            font-weight: 400;
        }

        /* 输入区域 */
        .input-section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
            border: 1px solid #e5e7eb;
        }

        .url-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            outline: none;
            transition: all 0.2s ease;
            background: #fafbfc;
            margin-bottom: 24px;
        }

        .url-input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .url-input::placeholder {
            color: #9ca3af;
        }

        .generate-btn {
            display: block;
            margin: 0 auto;
            width: 200px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-content {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 结果显示 */
        .result-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 32px;
            border: 1px solid #e5e7eb;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .result-url {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .result-link {
            flex: 1;
            color: #667eea;
            text-decoration: none;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .result-link:hover {
            text-decoration: underline;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: #5a67d8;
        }

        .copy-btn.copied {
            background: #48bb78;
        }

        /* 二维码按钮 */
        .qr-btn {
            padding: 6px 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        .qr-btn:hover {
            background: #7c3aed;
        }

        /* 二维码模态框 */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .qr-modal.show {
            display: flex;
        }

        .qr-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }

        .qr-modal.show .qr-modal-content {
            transform: scale(1);
        }

        .qr-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .qr-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }

        .qr-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-modal-close:hover {
            color: #374151;
        }

        .qr-modal-body {
            text-align: center;
        }

        .qr-code-image {
            width: 200px;
            height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .qr-hint {
            color: #6b7280;
            font-size: 14px;
            margin: 0;
        }

        /* 历史记录 */
        .history-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .history-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #fafbfc;
            border-radius: 8px;
            transition: all 0.2s ease;
            gap: 12px;
            margin-bottom: 8px;
        }

        .history-item:hover {
            background: #f1f5f9;
        }

        .favicon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .url-info {
            flex: 1;
            min-width: 0;
        }

        .original-url {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .short-url {
            font-size: 14px;
            color: #667eea;
            text-decoration: none;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .short-url:hover {
            text-decoration: underline;
        }

        .visit-hint {
            font-size: 10px;
            color: #9ca3af;
            margin-top: 1px;
        }

        .history-copy-btn {
            padding: 4px 8px;
            background: #e5e7eb;
            color: #374151;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .history-copy-btn:hover {
            background: #d1d5db;
        }

        /* 删除按钮 */
        .history-delete-btn {
            padding: 4px 6px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .history-delete-btn:hover {
            background: #fecaca;
            color: #b91c1c;
        }

        .history-delete-btn svg {
            width: 12px;
            height: 12px;
        }

        .empty-history {
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
            padding: 32px 16px;
        }

        /* 底部提示 */
        .footer-hint {
            text-align: center;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 40px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px 40px;
            }

            .main-title {
                font-size: 36px;
            }

            .subtitle {
                font-size: 16px;
            }

            .input-section {
                padding: 24px 20px;
            }

            .generate-btn {
                width: 100%;
            }

            .nav-links {
                display: none;
            }

            .navbar-content {
                padding: 0 16px;
            }

            .history-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .url-info {
                width: 100%;
            }

            .history-copy-btn {
                align-self: flex-end;
            }
        }

        /* 错误提示 */
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 12px;
            border: 1px solid #fecaca;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* 成功提示 */
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .success-toast.show {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- 深色导航栏 -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">TinyFlow</div>
            <div class="nav-links">
                <span>短链生成</span>
                <span>API文档</span>
                <span>关于</span>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="container">
        <!-- 标题区域 -->
        <header class="header">
            <h1 class="main-title">TinyFlow</h1>
            <p class="subtitle">缩短链接，加速分享</p>
        </header>

        <!-- 输入区域 -->
        <section class="input-section">
            <input 
                type="url" 
                id="urlInput" 
                class="url-input" 
                placeholder="请输入要缩短的网址，例如 https://www.example.com"
                autocomplete="off"
            >
            <button id="generateBtn" class="generate-btn">
                <div class="btn-content">
                    <div class="loading-spinner" id="loadingSpinner"></div>
                    <span id="btnText">生成短链</span>
                </div>
            </button>
            <div id="errorMessage" class="error-message"></div>
        </section>

        <!-- 结果显示 -->
        <section id="resultSection" class="result-section">
            <div class="result-label">生成的短链接：</div>
            <div class="result-url">
                <a id="resultLink" class="result-link" href="#" target="_blank"></a>
                <button id="resultCopyBtn" class="copy-btn">复制</button>
                <button id="qrCodeBtn" class="qr-btn" title="查看二维码">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="5" height="5"/>
                        <rect x="3" y="16" width="5" height="5"/>
                        <rect x="16" y="3" width="5" height="5"/>
                        <path d="m5 5 2 2"/>
                        <path d="m5 17 2 2"/>
                        <path d="m17 5 2 2"/>
                        <rect x="11" y="11" width="3" height="3"/>
                    </svg>
                </button>
            </div>
        </section>

        <!-- 历史记录 -->
        <section class="history-section">
            <h2 class="history-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                </svg>
                最近生成
            </h2>
            <div id="historyList" class="history-list">
                <div class="empty-history">暂无生成记录</div>
            </div>
        </section>

        <!-- 底部提示 -->
        <div class="footer-hint">
            请确保后端服务 http://localhost:8080 已启动并支持 CORS
        </div>
    </div>

    <!-- 成功提示 -->
    <div id="successToast" class="success-toast">
        ✅ 已复制到剪贴板
    </div>

    <!-- 二维码模态框 -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h3>二维码</h3>
                <button id="qrModalClose" class="qr-modal-close">&times;</button>
            </div>
            <div class="qr-modal-body">
                <img id="qrCodeImage" src="" alt="QR Code" class="qr-code-image">
                <p class="qr-hint">扫描二维码访问短链接</p>
            </div>
        </div>
    </div>

    <script>
        class TinyFlowApp {
            constructor() {
                this.initElements();
                this.bindEvents();
                this.loadHistory();
            }

            initElements() {
                this.urlInput = document.getElementById('urlInput');
                this.generateBtn = document.getElementById('generateBtn');
                this.loadingSpinner = document.getElementById('loadingSpinner');
                this.btnText = document.getElementById('btnText');
                this.errorMessage = document.getElementById('errorMessage');
                this.resultSection = document.getElementById('resultSection');
                this.resultLink = document.getElementById('resultLink');
                this.resultCopyBtn = document.getElementById('resultCopyBtn');
                this.qrCodeBtn = document.getElementById('qrCodeBtn');
                this.qrModal = document.getElementById('qrModal');
                this.qrModalClose = document.getElementById('qrModalClose');
                this.qrCodeImage = document.getElementById('qrCodeImage');
                this.historyList = document.getElementById('historyList');
                this.successToast = document.getElementById('successToast');
            }

            bindEvents() {
                this.generateBtn.addEventListener('click', () => this.generateShortUrl());
                this.urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.generateShortUrl();
                });
                this.urlInput.addEventListener('input', () => this.clearError());
                this.resultCopyBtn.addEventListener('click', () => this.copyResult());
                this.qrCodeBtn.addEventListener('click', () => this.showQrCode());
                this.qrModalClose.addEventListener('click', () => this.hideQrCode());
                this.qrModal.addEventListener('click', (e) => {
                    if (e.target === this.qrModal) this.hideQrCode();
                });
            }

            async generateShortUrl() {
                const url = this.urlInput.value.trim();
                
                if (!url) {
                    this.showError('请输入要缩短的网址');
                    return;
                }

                if (!this.isValidUrl(url)) {
                    this.showError('请输入有效的网址（必须以 http:// 或 https:// 开头）');
                    return;
                }

                this.setLoading(true);
                this.clearError();

                try {
                    const response = await fetch('http://localhost:8080/shorten', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: url
                    });

                    if (response.ok) {
                        // 成功响应：200 OK，响应体为纯文本短链接
                        const shortUrl = await response.text();
                        this.showResult(shortUrl.trim());
                        this.addToHistory(url, shortUrl.trim());
                        this.urlInput.value = '';
                    } else if (response.status === 400) {
                        // 错误响应：400，响应体为错误信息
                        const errorMessage = await response.text();
                        this.showError(errorMessage || 'URL 格式错误');
                    } else {
                        // 其他错误
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    console.error('生成短链失败:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        this.showError('无法连接到后端服务，请确保后端服务已启动 (http://localhost:8080)');
                    } else {
                        this.showError('生成失败：' + error.message);
                    }
                } finally {
                    this.setLoading(false);
                }
            }

            isValidUrl(string) {
                try {
                    const url = new URL(string);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch (_) {
                    return false;
                }
            }

            setLoading(loading) {
                this.generateBtn.disabled = loading;
                this.loadingSpinner.style.display = loading ? 'block' : 'none';
                this.btnText.textContent = loading ? '生成中...' : '生成短链';
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.add('show');
            }

            clearError() {
                this.errorMessage.classList.remove('show');
            }

            showResult(shortUrl) {
                this.resultLink.href = shortUrl;
                this.resultLink.textContent = shortUrl;
                this.resultSection.classList.add('show');
                this.resultCopyBtn.textContent = '复制';
                this.resultCopyBtn.classList.remove('copied');
            }

            async copyResult() {
                await this.copyToClipboard(this.resultLink.textContent);
                this.resultCopyBtn.textContent = '已复制';
                this.resultCopyBtn.classList.add('copied');
                setTimeout(() => {
                    this.resultCopyBtn.textContent = '复制';
                    this.resultCopyBtn.classList.remove('copied');
                }, 2000);
            }

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    this.showSuccessToast();
                } catch (err) {
                    // 降级方案
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showSuccessToast();
                }
            }

            showSuccessToast() {
                this.successToast.classList.add('show');
                setTimeout(() => {
                    this.successToast.classList.remove('show');
                }, 2000);
            }

            addToHistory(originalUrl, shortUrl) {
                let history = this.getHistory();
                
                // 避免重复
                history = history.filter(item => item.shortUrl !== shortUrl);
                
                // 添加到开头
                history.unshift({
                    originalUrl,
                    shortUrl,
                    timestamp: Date.now()
                });

                // 保持最多10条
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }

                localStorage.setItem('tinyflow_history', JSON.stringify(history));
                this.renderHistory();
            }

            getHistory() {
                try {
                    return JSON.parse(localStorage.getItem('tinyflow_history') || '[]');
                } catch {
                    return [];
                }
            }

            loadHistory() {
                this.renderHistory();
            }

            renderHistory() {
                const history = this.getHistory();
                
                if (history.length === 0) {
                    this.historyList.innerHTML = '<div class="empty-history">暂无生成记录</div>';
                    return;
                }

                this.historyList.innerHTML = history.map((item, index) => {
                    const domain = this.extractDomain(item.originalUrl);
                    const truncatedUrl = item.originalUrl.length > 30 
                        ? item.originalUrl.substring(0, 30) + '...' 
                        : item.originalUrl;

                    return `
                        <div class="history-item">
                            <img class="favicon" 
                                 src="https://www.google.com/s2/favicons?domain=${domain}&sz=16" 
                                 alt="favicon"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMSA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDMgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjOWNhM2FmIi8+Cjwvc3ZnPgo='">
                            <div class="url-info">
                                <div class="original-url">${truncatedUrl}</div>
                                <a href="${item.shortUrl}" target="_blank" class="short-url">${item.shortUrl}</a>
                                <div class="visit-hint">点击访问</div>
                            </div>
                            <button class="history-copy-btn" onclick="app.copyHistoryItem('${item.shortUrl}')">复制</button>
                            <button class="history-delete-btn" onclick="app.deleteHistoryItem(${index})" title="删除记录">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }).join('');
            }

            extractDomain(url) {
                try {
                    return new URL(url).hostname;
                } catch {
                    return 'example.com';
                }
            }

            async copyHistoryItem(shortUrl) {
                await this.copyToClipboard(shortUrl);
            }

            deleteHistoryItem(index) {
                let history = this.getHistory();
                
                if (index >= 0 && index < history.length) {
                    // 删除指定索引的项目
                    history.splice(index, 1);
                    
                    // 更新localStorage
                    localStorage.setItem('tinyflow_history', JSON.stringify(history));
                    
                    // 重新渲染历史记录
                    this.renderHistory();
                    
                    // 显示删除成功提示
                    this.showDeleteToast();
                }
            }

            showDeleteToast() {
                // 创建临时的删除提示
                const deleteToast = document.createElement('div');
                deleteToast.className = 'success-toast show';
                deleteToast.textContent = '🗑️ 已删除记录';
                deleteToast.style.background = '#f59e0b';
                document.body.appendChild(deleteToast);
                
                setTimeout(() => {
                    deleteToast.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(deleteToast);
                    }, 300);
                }, 1500);
            }

            showQrCode() {
                const shortUrl = this.resultLink.textContent;
                if (shortUrl) {
                    // 使用 Google Chart API 生成二维码
                    const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(shortUrl)}`;
                    this.qrCodeImage.src = qrUrl;
                    this.qrModal.classList.add('show');
                }
            }

            hideQrCode() {
                this.qrModal.classList.remove('show');
            }
        }

        // 初始化应用
        const app = new TinyFlowApp();
    </script>
</body>
</html>