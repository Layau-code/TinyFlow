const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DistributionChart-BUKvkJ3w.js","assets/index-DPYHsNN2.js","assets/index-Bnqld3q_.css","assets/DistributionChart-91z5xMqA.css","assets/TrendChart-DvXSpqmb.js","assets/TrendChart-EpDOQCrt.css"])))=>i.map(i=>d[i]);
import{u as ht,a as mt,r as C,c,w as N,o as bt,b as vt,d as h,e as u,f as e,t as o,g as pt,v as _t,h as v,i as x,j as A,k as H,n as q,l as K,m as L,S as ft,F as gt,p as yt,q as Ct,s as xt,_ as G,x as kt}from"./index-DPYHsNN2.js";import{u as Dt,a as Ft,b as $t,S as Vt,A as wt}from"./useStats-DvRBJ_hb.js";const St={class:"min-h-screen q-page font-[Inter,system-ui,-apple-system,sans-serif]"},Tt={class:"max-w-6xl mx-auto p-6"},Et={class:"flex items-center justify-between mb-8"},Nt={class:"md-text text-[24px] font-medium"},At={class:"flex items-center gap-4"},qt=["placeholder"],Lt={class:"flex items-center justify-between mb-3"},Bt={class:"md-label"},Pt={key:0,class:"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8"},Rt={class:"q-card p-6",style:{"box-shadow":"0 2px 12px rgba(0,0,0,0.04)"}},jt={class:"q-card-title mb-4"},Ut={class:"relative",style:{height:"280px",background:"#fafafa",border:"1px dashed #ddd","border-radius":"8px"}},Mt={key:0,class:"q-muted text-center mt-2"},It={class:"q-help mt-1"},Ot={class:"q-card p-6",style:{"box-shadow":"0 2px 12px rgba(0,0,0,0.04)"}},zt={class:"q-card-title mb-4"},Ht={class:"relative",style:{height:"280px",background:"#fafafa",border:"1px dashed #ddd","border-radius":"8px"}},Kt={key:0,class:"q-muted text-center mt-2"},Gt={class:"q-help mt-1"},Jt={key:1,class:"q-card p-6 mb-8",style:{"box-shadow":"0 2px 12px rgba(0,0,0,0.04)"}},Qt={class:"q-card-title mb-4 flex items-center justify-between"},Wt={class:"flex items-center gap-2"},Xt={class:"relative",style:{height:"280px",background:"#fafafa",border:"1px dashed #ddd","border-radius":"8px"}},Yt={key:0,class:"q-muted text-center mt-2"},Zt={class:"q-help mt-3"},te={class:"md-card p-5 mb-10"},ee={class:"flex items-center justify-between mb-3"},se={class:"md-label"},ae={class:"overflow-x-auto"},oe={class:"md-table"},le={class:"md-th text-left"},de={class:"md-th text-left"},ne={class:"md-th text-right"},re={class:"md-th text-right"},ie={class:"md-th text-left"},ce={class:"md-th text-left"},ue={class:"md-th text-left"},he={class:"md-td font-medium"},me={class:"md-td truncate max-w-[420px] md-muted"},be={class:"md-td text-right md-nums"},ve={style:{color:"#6E44FF"}},pe={class:"md-td text-right md-nums"},_e={class:"md-td"},fe={class:"flex items-center gap-2"},ge={class:"w-[160px] h-2 rounded",style:{background:"var(--divider)"}},ye={class:"md-muted"},Ce={class:"md-td"},xe={class:"md-td"},ke={class:"flex items-center gap-3 md-actions"},De=["onClick"],Fe=["onClick"],$e={key:0},Ve={colspan:"7",class:"p-4 text-center md-muted"},we={key:1},Se={colspan:"7",class:"p-4 text-center md-muted"},Te={class:"flex items-center justify-between mt-4"},Ee={class:"md-muted"},Ne={class:"flex items-center gap-3"},B=10,Be={__name:"DashboardPage",setup(Ae){const P=H(()=>G(()=>import("./DistributionChart-BUKvkJ3w.js"),__vite__mapDeps([0,1,2,3]))),J=H(()=>G(()=>import("./TrendChart-DvXSpqmb.js"),__vite__mapDeps([4,1,2,5])));ht();const{t:m}=mt(),w=C(""),p=C(1),{data:Q,loading:R,refresh:$}=Dt(),{data:V,refresh:j}=Ft(),S=Q,U=["#6E44FF","#8A7CFD","#7A5BFF","#9D8BFF","#B0A4FF","#C7BEFF","#D6D1FF","#E0DCFF","#EAE8FF"],k=c(()=>M(V.value||[],"totalVisits")),D=c(()=>M(V.value||[],"todayVisits")),W=c(()=>(k.value||[]).reduce((t,s)=>t+Number(s.value||0),0)>0),X=c(()=>(D.value||[]).reduce((t,s)=>t+Number(s.value||0),0)>0),Y=c(()=>(k.value||[]).reduce((t,s)=>t+Number(s.value||0),0)),Z=c(()=>(D.value||[]).reduce((t,s)=>t+Number(s.value||0),0));N([D,k],([t,s])=>{try{const i=(t||[]).reduce((n,d)=>n+Number(d.value||0),0),a=(s||[]).reduce((n,d)=>n+Number(d.value||0),0);console.log("[Dashboard] Pie sums => today:",i,", total:",a)}catch{}}),N(S,t=>{try{console.log("[Dashboard] list length:",(t||[]).length,"first item:",(t||[])[0])}catch{}}),N(V,t=>{try{console.log("[Dashboard] click-stats length:",(t||[]).length,"first item:",(t||[])[0])}catch{}});function M(t,s){const a=(t||[]).map(l=>({name:l.shortCode,label:l.shortCode,value:Number(l[s]||0)})).sort((l,r)=>r.value-l.value);if(a.reduce((l,r)=>l+r.value,0),a.length<=8)return a;const n=a.slice(0,7),d=a.slice(7).reduce((l,r)=>l+r.value,0);return d>0&&n.push({name:m("dashboard.other"),label:m("dashboard.other"),value:d}),n}const f=C(!1),b=C(7),_=C([]),g=C([]),{data:tt,refresh:et}=$t();async function I(){try{const t=[...S.value||[]].sort((d,l)=>(l.totalVisits||0)-(d.totalVisits||0)).slice(0,5).map(d=>d.shortCode);if(!t.length){_.value=[],g.value=[];return}await et(t,b.value);const s=tt.value||{},i=new Set;t.forEach(d=>(s[d]||[]).forEach(l=>i.add(String(l.date))));const a=Array.from(i).sort(),n=t.map((d,l)=>{const r=new Map((s[d]||[]).map(F=>[String(F.date),Number(F.visits||0)])),ut=a.map(F=>({label:F,value:r.get(F)??0}));return{name:d,color:["#4F46E5","#06B6D4","#F59E0B","#10B981","#EF4444"][l%5],series:ut}});_.value=a,g.value=n}catch(t){console.log("[Dashboard] refreshDashboardTrend7 error:",t),_.value=[],g.value=[]}}function st(){f.value=!f.value,f.value&&!_.value.length&&I()}function T(t){b.value!==t&&(b.value=t,f.value&&I())}const E=c(()=>{const t=y.value||[],s=t.reduce((a,n)=>a+Number(n.totalVisits||0),0)||1,i={};return t.forEach(a=>{i[a.shortCode]=Number(a.totalVisits||0)/s*100}),i}),at=c(()=>{const t={};return(V.value||[]).forEach(s=>{t[s.shortCode]={totalVisits:Number(s.totalVisits||0),todayVisits:Number(s.todayVisits||0)}}),t}),ot=c(()=>(S.value||[]).map(t=>{const s=at.value[t.shortCode]||{};return{...t,totalVisits:s.totalVisits??Number(t.totalVisits||0),todayVisits:s.todayVisits??Number(t.todayVisits||0)}}));function lt(){const t=[m("dashboard.table.shortCode"),m("dashboard.table.total"),m("dashboard.table.today"),m("dashboard.table.share"),m("dashboard.table.createdAt"),m("dashboard.table.url")],i=(y.value||[]).map(r=>[r.shortCode,r.totalVisits??"-",r.todayVisits??"-",(E.value[r.shortCode]||0).toFixed(2),z(r.createdAt),r.longUrl||""]),a=[t.join(","),...i.map(r=>r.join(","))].join(`
`),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(n),l=document.createElement("a");l.href=d,l.download=`${m("history.title")}.csv`,l.click(),URL.revokeObjectURL(d)}const y=c(()=>{const t=w.value.trim().toLowerCase(),s=ot.value||[];return(t?s.filter(a=>(a.shortCode||"").toLowerCase().includes(t)||(a.longUrl||"").toLowerCase().includes(t)):[...s]).sort((a,n)=>Number(n.totalVisits||0)-Number(a.totalVisits||0))}),O=c(()=>Math.max(1,Math.ceil(y.value.length/B))),dt=c(()=>y.value.slice((p.value-1)*B,p.value*B));function nt(){p.value=Math.max(1,p.value-1)}function rt(){p.value=Math.min(O.value,p.value+1)}function z(t){try{return new Date(t).toLocaleString()}catch{return String(t)}}bt(async()=>{await Promise.all([$(),j()])});function it(t){try{navigator.clipboard.writeText(String(t))}catch(s){console.log("copy failed",s)}}async function ct(t){if(t)try{await kt.delete((wt||"")+"/api/"+encodeURIComponent(t)),await Promise.all([$(),j()])}catch(s){console.log("remove failed",s),alert("删除失败，请稍后重试")}}return(t,s)=>{const i=vt("router-link");return u(),h("div",St,[e("div",Tt,[e("div",Et,[e("h1",Nt,o(t.$t("dashboard.title")),1),e("div",At,[pt(e("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>w.value=a),type:"text",placeholder:t.$t("dashboard.searchPlaceholder"),class:"h-9 px-3 rounded-lg border",style:{"border-color":"#E5E7EB",background:"#FFFFFF",color:"#333333"}},null,8,qt),[[_t,w.value]]),e("button",{onClick:s[1]||(s[1]=(...a)=>v($)&&v($)(...a)),class:"md-btn-text"},o(t.$t("dashboard.refresh")),1)])]),e("div",Lt,[e("div",Bt,o(t.$t("dashboard.overview")),1),e("button",{class:"md-btn-text",onClick:st},o(f.value?t.$t("dashboard.toggleShowPie"):t.$t("dashboard.toggleShowTrend")),1)]),f.value?(u(),h("div",Jt,[e("div",Qt,[e("span",null,o(t.$t("dashboard.toggleShowTrend"))+"（Top 5 / "+o(b.value)+"天）",1),e("div",Wt,[e("button",{class:q(["md-btn-text",{"font-semibold":b.value===7}]),onClick:s[2]||(s[2]=a=>T(7))},"7天",2),e("button",{class:q(["md-btn-text",{"font-semibold":b.value===14}]),onClick:s[3]||(s[3]=a=>T(14))},"14天",2),e("button",{class:q(["md-btn-text",{"font-semibold":b.value===30}]),onClick:s[4]||(s[4]=a=>T(30))},"30天",2)])]),e("div",Xt,[(u(),K(ft,null,{fallback:L(()=>[...s[7]||(s[7]=[e("div",{class:"h-[240px] md-card"},null,-1)])]),default:L(()=>[_.value.length&&g.value.length?(u(),K(v(J),{key:0,multi:!0,series:g.value,labels:_.value},null,8,["series","labels"])):x("",!0)]),_:1}))]),!_.value.length||!g.value.length?(u(),h("div",Yt,o(t.$t("dashboard.noDataOrNone")),1)):x("",!0),e("div",Zt,o(t.$t("dashboard.descTop5Trend"))+"（"+o(b.value)+"天）",1)])):(u(),h("div",Pt,[e("div",Rt,[e("div",jt,o(t.$t("dashboard.todayDist")),1),e("div",Ut,[A(v(P),{type:"pie",data:D.value,colors:U,engine:"echarts"},null,8,["data"])]),X.value?x("",!0):(u(),h("div",Mt,o(t.$t("common.noData")),1)),e("div",It,"数据条数："+o(D.value.length)+"，总和："+o(Z.value),1),s[5]||(s[5]=e("div",{class:"q-help mt-3"},"悬停查看名称、百分比与数值",-1))]),e("div",Ot,[e("div",zt,o(t.$t("dashboard.totalDist")),1),e("div",Ht,[A(v(P),{type:"pie",data:k.value,colors:U,engine:"echarts"},null,8,["data"])]),W.value?x("",!0):(u(),h("div",Kt,o(t.$t("common.noData")),1)),e("div",Gt,"数据条数："+o(k.value.length)+"，总和："+o(Y.value),1),s[6]||(s[6]=e("div",{class:"q-help mt-3"},"悬停查看名称、百分比与数值",-1))])])),e("div",te,[e("div",ee,[e("div",se,o(t.$t("history.title")),1),e("button",{class:"md-btn",onClick:lt},o(t.$t("dashboard.exportCsv")),1)]),e("div",ae,[e("table",oe,[e("thead",null,[e("tr",null,[e("th",le,o(t.$t("dashboard.table.shortCode")),1),e("th",de,o(t.$t("dashboard.table.url")),1),e("th",ne,o(t.$t("dashboard.table.total")),1),e("th",re,o(t.$t("dashboard.table.today")),1),e("th",ie,o(t.$t("dashboard.table.share")),1),e("th",ce,o(t.$t("dashboard.table.createdAt")),1),e("th",ue,o(t.$t("dashboard.table.actions")),1)])]),e("tbody",null,[(u(!0),h(gt,null,yt(dt.value,a=>(u(),h("tr",{key:a.shortCode,class:"md-tr"},[e("td",he,o(a.shortCode),1),e("td",me,o(a.longUrl),1),e("td",be,[e("span",ve,o(a.totalVisits??"-"),1)]),e("td",pe,o(a.todayVisits===0?"-":a.todayVisits??"-"),1),e("td",_e,[e("div",fe,[e("div",ge,[e("div",{class:"h-2 rounded",style:Ct({width:(E.value[a.shortCode]||0).toFixed(2)+"%",background:"#8A7CFD"})},null,4)]),e("span",ye,o((E.value[a.shortCode]||0).toFixed(2))+"%",1)])]),e("td",Ce,o(z(a.createdAt)),1),e("td",xe,[e("div",ke,[A(i,{to:"/stats/"+encodeURIComponent(a.shortCode),class:"md-btn-text"},{default:L(()=>[xt(o(t.$t("stats.details")),1)]),_:1},8,["to"]),e("button",{class:"md-btn-text",onClick:n=>it(v(Vt)+"/"+encodeURIComponent(a.shortCode))},o(t.$t("actions.copy")),9,De),e("button",{class:"md-btn-text",onClick:n=>ct(a.shortCode)},o(t.$t("actions.delete")),9,Fe)])])]))),128)),v(R)?(u(),h("tr",$e,[e("td",Ve,o(t.$t("common.loading")),1)])):x("",!0),!v(R)&&y.value.length===0?(u(),h("tr",we,[e("td",Se,o(t.$t("common.noData")),1)])):x("",!0)])])]),e("div",Te,[e("div",Ee,o(t.$t("dashboard.pagination.total",{count:y.value.length,page:p.value,pages:O.value})),1),e("div",Ne,[e("button",{onClick:nt,class:"md-btn-text"},o(t.$t("dashboard.pagination.prev")),1),e("button",{onClick:rt,class:"md-btn-text"},o(t.$t("dashboard.pagination.next")),1)])])])])])}}};export{Be as default};
